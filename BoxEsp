local lplr = game.Players.LocalPlayer
local camera = game:GetService("Workspace").CurrentCamera
local currentCamera = workspace.CurrentCamera
local worldToViewportPoint = currentCamera.worldToViewportPoint

local HeadOff = Vector3.new(0, 0.5, 0)
local LegOff = Vector3.new(0,3,0)

-- Configurações
_G.temcheck = true
_G.temcheckmode = "colors" -- opções: "colors", "invisible"
_G.teamcolor = Color3.new(0, 1, 0) -- Cor para o time
_G.enemycolor = Color3.new(1, 0, 0) -- Cor para inimigos

-- Configurações BoxOutline e Box
_G.boxOutlineColor = Color3.new(0, 0, 0)
_G.boxOutlineThickness = 3
_G.boxOutlineTransparency = 1
_G.boxOutlineVisible = true

_G.boxColor = Color3.new(0, 0, 0)
_G.boxThickness = 1
_G.boxTransparency = 1
_G.boxVisible = true

-- Configurações BoxFilled
_G.boxFilledColor = Color3.new(0, 0, 0)
_G.boxFilledTransparency = 0.5
_G.boxFilledVisible = true

-- Definir Box, BoxOutline e BoxFilled no início
local function createDrawingObjects()
    local BoxOutline = Drawing.new("Square")
    BoxOutline.Visible = _G.boxOutlineVisible
    BoxOutline.Color = _G.boxOutlineColor
    BoxOutline.Thickness = _G.boxOutlineThickness
    BoxOutline.Transparency = _G.boxOutlineTransparency
    BoxOutline.Filled = false

    local Box = Drawing.new("Square")
    Box.Visible = _G.boxVisible
    Box.Color = _G.boxColor
    Box.Thickness = _G.boxThickness
    Box.Transparency = _G.boxTransparency
    Box.Filled = false

    local BoxFilled = Drawing.new("Square")
    BoxFilled.Visible = _G.boxFilledVisible
    BoxFilled.Color = _G.boxFilledColor
    BoxFilled.Transparency = _G.boxFilledTransparency
    BoxFilled.Filled = true
    
    return BoxOutline, Box, BoxFilled
end

for i, v in pairs(game.Players:GetChildren()) do
    local BoxOutline, Box, BoxFilled = createDrawingObjects()
    
    local function boxesp()
        game:GetService("RunService").RenderStepped:Connect(function()
            if _G.temcheck and v.Character and v.Character:FindFirstChild("Humanoid") and v.Character:FindFirstChild("HumanoidRootPart") and v ~= lplr and v.Character.Humanoid.Health > 0 then
                local Vector, onScreen = camera:WorldToViewportPoint(v.Character.HumanoidRootPart.Position)
                
                local RootPart = v.Character.HumanoidRootPart
                local Head = v.Character.Head
                local RootPosition, RootVis = worldToViewportPoint(currentCamera, RootPart.Position)
                local HeadPosition = worldToViewportPoint(currentCamera, Head.Position + HeadOff)
                local LegPosition = worldToViewportPoint(currentCamera, RootPart.Position - LegOff)
                
                if onScreen then
                    BoxOutline.Size = Vector2.new(1000 / RootPosition.Z, HeadPosition.Y - LegPosition.Y)
                    BoxOutline.Position = Vector2.new(RootPosition.X - BoxOutline.Size.X / 2, RootPosition.Y - BoxOutline.Size.Y / 2)
                    BoxOutline.Visible = true
                    
                    Box.Size =  Vector2.new(1000 / RootPosition.Z, HeadPosition.Y - LegPosition.Y)
                    Box.Position = Vector2.new(RootPosition.X - Box.Size.X / 2, RootPosition.Y - Box.Size.Y / 2)
                    Box.Visible = true

                    BoxFilled.Size = Vector2.new(1000 / RootPosition.Z, HeadPosition.Y - LegPosition.Y)
                    BoxFilled.Position = Vector2.new(RootPosition.X - Box.Size.X / 2, RootPosition.Y - Box.Size.Y / 2)
                    BoxFilled.Visible = true

                    if _G.temcheckmode == "colors" then
                        if v.TeamColor == lplr.TeamColor then
                            Box.Color = _G.teamcolor
                            BoxFilled.Color = _G.teamcolor
                        else
                            Box.Color = _G.enemycolor
                            BoxFilled.Color = _G.enemycolor
                        end
                    elseif _G.temcheckmode == "invisible" then
                        if v.TeamColor == lplr.TeamColor then
                            Box.Visible = false
                            BoxOutline.Visible = false
                            BoxFilled.Visible = false
                        else
                            Box.Color = _G.enemycolor
                            BoxFilled.Color = _G.enemycolor
                        end
                    end
                    
                else
                    BoxOutline.Visible = false
                    Box.Visible = false
                    BoxFilled.Visible = false
                end
            else
                BoxOutline.Visible = false
                Box.Visible = false
                BoxFilled.Visible = false
            end
        end)
    end
    coroutine.wrap(boxesp)()
end

game.Players.PlayerAdded:Connect(function(v)
    local BoxOutline, Box, BoxFilled = createDrawingObjects()

    local function boxesp()
        game:GetService("RunService").RenderStepped:Connect(function()
            if _G.temcheck and v.Character and v.Character:FindFirstChild("Humanoid") and v.Character:FindFirstChild("HumanoidRootPart") and v ~= lplr and v.Character.Humanoid.Health > 0 then
                local Vector, onScreen = camera:WorldToViewportPoint(v.Character.HumanoidRootPart.Position)

                local RootPart = v.Character.HumanoidRootPart
                local Head = v.Character.Head
                local RootPosition, RootVis = worldToViewportPoint(currentCamera, RootPart.Position)
                local HeadPosition = worldToViewportPoint(currentCamera, Head.Position + HeadOff)
                local LegPosition = worldToViewportPoint(currentCamera, RootPart.Position - LegOff)

                if onScreen then
                    BoxOutline.Size = Vector2.new(1000 / RootPosition.Z, HeadPosition.Y - LegPosition.Y)
                    BoxOutline.Position = Vector2.new(RootPosition.X - BoxOutline.Size.X / 2, RootPosition.Y - BoxOutline.Size.Y / 2)
                    BoxOutline.Visible = true

                    Box.Size =  Vector2.new(1000 / RootPosition.Z, HeadPosition.Y - LegPosition.Y)
                    Box.Position = Vector2.new(RootPosition.X - Box.Size.X / 2, RootPosition.Y - Box.Size.Y / 2)
                    Box.Visible = true

                    BoxFilled.Size = Vector2.new(1000 / RootPosition.Z, HeadPosition.Y - LegPosition.Y)
                    BoxFilled.Position = Vector2.new(RootPosition.X - Box.Size.X / 2, RootPosition.Y - Box.Size.Y / 2)
                    BoxFilled.Visible = true

                    if _G.temcheckmode == "colors" then
                        if v.TeamColor == lplr.TeamColor then
                            Box.Color = _G.teamcolor
                            BoxFilled.Color = _G.teamcolor
                        else
                            Box.Color = _G.enemycolor
                            BoxFilled.Color = _G.enemycolor
                        end
                    elseif _G.temcheckmode == "invisible" then
                        if v.TeamColor == lplr.TeamColor then
                            Box.Visible = false
                            BoxOutline.Visible = false
                            BoxFilled.Visible = false
                        else
                            Box.Color = _G.enemycolor
                            BoxFilled.Color = _G.enemycolor
                        end
                    end
                    
                else
                    BoxOutline.Visible = false
                    Box.Visible = false
                    BoxFilled.Visible = false
                end
            else
                BoxOutline.Visible = false
                Box.Visible = false
                BoxFilled.Visible = false
            end
        end)
    end
    coroutine.wrap(boxesp)()
end)
