local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Camera = workspace.CurrentCamera
local LocalPlayer = Players.LocalPlayer

local ESPBoxes = {}

-- Criar uma linha
local function CreateLine()
    local line = Drawing.new("Line")
    line.Thickness = 2
    line.Color = Color3.fromRGB(255, 0, 0) -- Vermelho
    line.Visible = false
    return line
end

-- Criar ESP 3D
local function CreateESP(player)
    if player == LocalPlayer then return end -- Evita ESP para si mesmo

    -- Criar 12 linhas para formar a caixa 3D
    ESPBoxes[player] = {
        CreateLine(), CreateLine(), CreateLine(), CreateLine(), -- Topo
        CreateLine(), CreateLine(), CreateLine(), CreateLine(), -- Base
        CreateLine(), CreateLine(), CreateLine(), CreateLine()  -- Laterais
    }

    local function Update()
        if not player.Character or not player.Character:FindFirstChild("HumanoidRootPart") then
            for _, line in ipairs(ESPBoxes[player]) do
                line.Visible = false
            end
            return
        end

        local rootPart = player.Character.HumanoidRootPart
        local size = Vector3.new(3, 6, 3) -- Tamanho do ESP Box
        local corners = {
            rootPart.CFrame * CFrame.new(-size.X, size.Y, -size.Z), -- 1
            rootPart.CFrame * CFrame.new(size.X, size.Y, -size.Z),  -- 2
            rootPart.CFrame * CFrame.new(size.X, size.Y, size.Z),   -- 3
            rootPart.CFrame * CFrame.new(-size.X, size.Y, size.Z),  -- 4

            rootPart.CFrame * CFrame.new(-size.X, -size.Y, -size.Z), -- 5
            rootPart.CFrame * CFrame.new(size.X, -size.Y, -size.Z),  -- 6
            rootPart.CFrame * CFrame.new(size.X, -size.Y, size.Z),   -- 7
            rootPart.CFrame * CFrame.new(-size.X, -size.Y, size.Z),  -- 8
        }

        -- Converter para coordenadas da tela
        local screenCorners, isVisible = {}, false
        for i, corner in ipairs(corners) do
            local screenPos, onScreen = Camera:WorldToViewportPoint(corner.Position)
            screenCorners[i] = Vector2.new(screenPos.X, screenPos.Y)
            if onScreen then
                isVisible = true
            end
        end

        if isVisible then
            local lines = ESPBoxes[player]

            -- Linhas do topo
            lines[1].From = screenCorners[1]
            lines[1].To = screenCorners[2]

            lines[2].From = screenCorners[2]
            lines[2].To = screenCorners[3]

            lines[3].From = screenCorners[3]
            lines[3].To = screenCorners[4]

            lines[4].From = screenCorners[4]
            lines[4].To = screenCorners[1]

            -- Linhas da base
            lines[5].From = screenCorners[5]
            lines[5].To = screenCorners[6]

            lines[6].From = screenCorners[6]
            lines[6].To = screenCorners[7]

            lines[7].From = screenCorners[7]
            lines[7].To = screenCorners[8]

            lines[8].From = screenCorners[8]
            lines[8].To = screenCorners[5]

            -- Linhas verticais
            lines[9].From = screenCorners[1]
            lines[9].To = screenCorners[5]

            lines[10].From = screenCorners[2]
            lines[10].To = screenCorners[6]

            lines[11].From = screenCorners[3]
            lines[11].To = screenCorners[7]

            lines[12].From = screenCorners[4]
            lines[12].To = screenCorners[8]

            -- Ativar visibilidade
            for _, line in ipairs(lines) do
                line.Visible = true
            end
        else
            for _, line in ipairs(ESPBoxes[player]) do
                line.Visible = false
            end
        end
    end

    RunService.RenderStepped:Connect(Update)
end

-- Adicionar ESP para novos jogadores
local function OnPlayerAdded(player)
    player.CharacterAdded:Connect(function()
        wait(0.5) -- Espera carregar a Character
        CreateESP(player)
    end)
end

-- Aplicar ESP a jogadores existentes
for _, player in ipairs(Players:GetPlayers()) do
    if player ~= LocalPlayer then
        OnPlayerAdded(player)
    end
end

-- Conectar eventos
Players.PlayerAdded:Connect(OnPlayerAdded)
Players.PlayerRemoving:Connect(function(player)
    if ESPBoxes[player] then
        for _, line in ipairs(ESPBoxes[player]) do
            line:Remove()
        end
        ESPBoxes[player] = nil
    end
end)
