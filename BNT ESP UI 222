local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Camera = game.Workspace.CurrentCamera
local LocalPlayer = Players.LocalPlayer

local ESP_Boxes = {}

local function CreateCornerBox()
    local thickness = 1
    local box = {
        TopLeft = Drawing.new("Line"),
        TopLeftVertical = Drawing.new("Line"),
        TopRight = Drawing.new("Line"),
        TopRightVertical = Drawing.new("Line"),
        BottomLeft = Drawing.new("Line"),
        BottomLeftVertical = Drawing.new("Line"),
        BottomRight = Drawing.new("Line"),
        BottomRightVertical = Drawing.new("Line")
    }
    
    for _, line in pairs(box) do
        line.Color = Color3.fromRGB(255, 0, 0)
        line.Thickness = thickness
        line.Visible = false
    end
    
    return box
end

RunService.RenderStepped:Connect(function()
    for _, v in pairs(Players:GetPlayers()) do
        if v ~= LocalPlayer and v.Character and v.Character:FindFirstChild("HumanoidRootPart") then
            local RootPart = v.Character.HumanoidRootPart
            local Head = v.Character.Head
            
            local HeadOff = Vector3.new(0, 0.5, 0)
            local LegOff = Vector3.new(0, 3, 0)
            
            local RootPosition, RootVis = Camera:WorldToViewportPoint(RootPart.Position)
            local HeadPosition = Camera:WorldToViewportPoint(Head.Position + HeadOff)
            local LegPosition = Camera:WorldToViewportPoint(RootPart.Position - LegOff)
            
            if not ESP_Boxes[v] then
                ESP_Boxes[v] = CreateCornerBox()
            end
            
            local box = ESP_Boxes[v]
            
            if RootVis then
                local BoxSize = Vector2.new(1000 / RootPosition.Z, HeadPosition.Y - LegPosition.Y)
                local BoxPosition = Vector2.new(RootPosition.X - BoxSize.X / 2, RootPosition.Y - BoxSize.Y / 2)
                local cornerLength = BoxSize.X * 0.2
                
                box.TopLeft.From = BoxPosition + Vector2.new(0, cornerLength)
                box.TopLeft.To = BoxPosition
                
                box.TopLeftVertical.From = BoxPosition + Vector2.new(cornerLength, 0)
                box.TopLeftVertical.To = BoxPosition
                
                box.TopRight.From = BoxPosition + Vector2.new(BoxSize.X - cornerLength, 0)
                box.TopRight.To = BoxPosition + Vector2.new(BoxSize.X, 0)
                
                box.TopRightVertical.From = BoxPosition + Vector2.new(BoxSize.X, cornerLength)
                box.TopRightVertical.To = BoxPosition + Vector2.new(BoxSize.X, 0)
                
                box.BottomLeft.From = BoxPosition + Vector2.new(0, BoxSize.Y - cornerLength)
                box.BottomLeft.To = BoxPosition + Vector2.new(0, BoxSize.Y)
                
                box.BottomLeftVertical.From = BoxPosition + Vector2.new(cornerLength, BoxSize.Y)
                box.BottomLeftVertical.To = BoxPosition + Vector2.new(0, BoxSize.Y)
                
                box.BottomRight.From = BoxPosition + Vector2.new(BoxSize.X, BoxSize.Y - cornerLength)
                box.BottomRight.To = BoxPosition + Vector2.new(BoxSize.X, BoxSize.Y)
                
                box.BottomRightVertical.From = BoxPosition + Vector2.new(BoxSize.X - cornerLength, BoxSize.Y)
                box.BottomRightVertical.To = BoxPosition + Vector2.new(BoxSize.X, BoxSize.Y)
                
                for _, line in pairs(box) do
                    line.Visible = true
                end
            else
                for _, line in pairs(box) do
                    line.Visible = false
                end
            end
        end
    end
end)
