local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Camera = workspace.CurrentCamera
local LocalPlayer = Players.LocalPlayer

local ESP_Boxes = {}

-- Deslocamentos para cabe√ßa e pernas
local HeadOff = Vector3.new(0, 0.5, 0)
local LegOff = Vector3.new(0, 3, 0)

function CreateBox(Player)
    if not ESP_Boxes[Player] then
        local Box = Drawing.new("Square")
        Box.Visible = false
        Box.Color = Color3.fromRGB(255, 0, 0) -- Vermelho
        Box.Thickness = 2
        Box.Filled = false
        ESP_Boxes[Player] = Box
    end
end

function RemoveBox(Player)
    if ESP_Boxes[Player] then
        ESP_Boxes[Player]:Remove()
        ESP_Boxes[Player] = nil
    end
end

function UpdateESP()
    for _, Player in pairs(Players:GetPlayers()) do
        if Player ~= LocalPlayer and Player.Character and Player.Character:FindFirstChild("HumanoidRootPart") and Player.Character:FindFirstChild("Head") then
            local RootPart = Player.Character.HumanoidRootPart
            local Head = Player.Character.Head

            local RootPosition, RootVis = Camera:WorldToViewportPoint(RootPart.Position)
            local HeadPosition = Camera:WorldToViewportPoint(Head.Position + HeadOff)
            local LegPosition = Camera:WorldToViewportPoint(RootPart.Position - LegOff)

            if RootVis then
                local Box = ESP_Boxes[Player]
                if Box then
                    Box.Size = Vector2.new(1000 / RootPosition.Z, HeadPosition.Y - LegPosition.Y)
                    Box.Position = Vector2.new(RootPosition.X - Box.Size.X / 2, RootPosition.Y - Box.Size.Y / 2)
                    Box.Visible = true
                end
            else
                if ESP_Boxes[Player] then
                    ESP_Boxes[Player].Visible = false
                end
            end
        end
    end
end

for _, Player in pairs(Players:GetPlayers()) do
    if Player ~= LocalPlayer then
        CreateBox(Player)
    end
end

Players.PlayerAdded:Connect(function(Player)
    if Player ~= LocalPlayer then
        CreateBox(Player)
    end
end)

Players.PlayerRemoving:Connect(function(Player)
    RemoveBox(Player)
end)

RunService.RenderStepped:Connect(UpdateESP)
